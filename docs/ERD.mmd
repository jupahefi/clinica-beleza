erDiagram
  FICHA ||--o{ FICHA_ESPECIFICA : tiene
  FICHA ||--o{ CONSENTIMIENTO_FIRMA : firma
  TIPO_FICHA_ESPECIFICA ||--o{ FICHA_ESPECIFICA : clasifica
  FICHA_ESPECIFICA ||--o{ ZONA_CUERPO : incluye
  PROFESIONAL ||--o{ CONSENTIMIENTO_FIRMA : atestigua

  TRATAMIENTO ||--o{ PACK : tiene
  TRATAMIENTO ||--o{ PRECIO_TRATAMIENTO : tiene
  FICHA ||--o{ EVALUACION : recibe
  TRATAMIENTO ||--o{ EVALUACION : evalua
  PACK ||--o{ EVALUACION : "(opcional)"

  FICHA ||--o{ VENTA : compra
  EVALUACION ||--o{ VENTA : "(requerida si tratamiento lo exige)"
  TRATAMIENTO ||--o{ VENTA : incluye
  PACK ||--o{ VENTA : "(opcional)"

  VENTA ||--o{ SESION : agenda
  SUCURSAL ||--o{ SESION : se_realiza_en
  BOX ||--o{ SESION : ocupa
  PROFESIONAL ||--o{ SESION : atiende
  SUCURSAL ||--o{ BOX : tiene

  OFERTA ||--o{ OFERTA_PACK : aplica_a
  OFERTA ||--o{ OFERTA_TRATAMIENTO : aplica_a
  PACK ||--o{ OFERTA_PACK : afectado
  TRATAMIENTO ||--o{ OFERTA_TRATAMIENTO : afectado
  OFERTA ||--o{ OFERTA_COMBO : define
  OFERTA_COMBO ||--o{ OFERTA_COMBO_PACK : incluye
  PACK ||--o{ OFERTA_COMBO_PACK : parte

  VENTA ||--o{ VENTA_OFERTA : "descuento sobre descuento"
  OFERTA ||--o{ VENTA_OFERTA : aplicado

  VENTA ||--o{ PAGO : recibe
  PAGO ||--o{ PAGO_DETALLE : tiene

  FICHA {
    bigserial id PK
    varchar codigo
    varchar nombres
    varchar apellidos
    varchar rut
    varchar telefono
    varchar email
    date fecha_nacimiento
    text direccion
    text observaciones
    timestamptz fecha_creacion
    timestamptz fecha_actualizacion
  }

  TIPO_FICHA_ESPECIFICA {
    bigserial id PK
    varchar nombre
    text descripcion
    boolean requiere_consentimiento
    text template_consentimiento
  }

  FICHA_ESPECIFICA {
    bigserial id PK
    bigint ficha_id FK
    bigint tipo_id FK
    jsonb datos
    timestamptz fecha_creacion
  }

  CONSENTIMIENTO_FIRMA {
    bigserial id PK
    bigint ficha_id FK
    bigint ficha_especifica_id FK
    varchar tipo_consentimiento
    bytea firma_blob
    varchar tipo_archivo
    timestamptz fecha_firma
    bigint profesional_id FK
    text observaciones
  }

  ZONA_CUERPO {
    varchar codigo PK
    varchar nombre
    varchar categoria
    numeric precio_base
    boolean activo
  }

  TRATAMIENTO {
    bigserial id PK
    varchar nombre
    text descripcion
    boolean requiere_ficha_especifica
    int duracion_sesion_min
    int frecuencia_recomendada_dias
    boolean activo
    timestamptz fecha_creacion
  }

  PRECIO_TRATAMIENTO {
    bigserial id PK
    bigint tratamiento_id FK
    numeric precio_regular
    numeric precio_oferta
    date fecha_inicio_oferta
    date fecha_fin_oferta
    boolean activo
    timestamptz fecha_creacion
  }

  PACK {
    bigserial id PK
    bigint tratamiento_id FK
    varchar nombre
    text descripcion
    int duracion_sesion_min
    int sesiones_incluidas
    jsonb zonas_incluidas
    jsonb precio_por_zona
    numeric precio_regular
    numeric precio_oferta
    date fecha_inicio_oferta
    date fecha_fin_oferta
    boolean activo
    timestamptz fecha_creacion
  }

  EVALUACION {
    bigserial id PK
    bigint ficha_id FK
    bigint tratamiento_id FK
    bigint pack_id FK
    bigint profesional_id FK
    numeric precio_sugerido
    int sesiones_sugeridas
    text observaciones
    timestamptz fecha
  }

  OFERTA {
    bigserial id PK
    varchar nombre
    varchar tipo
    text descripcion
    numeric porc_descuento
    date fecha_inicio
    date fecha_fin
    boolean combinable
    boolean activo
    int prioridad
    timestamptz fecha_creacion
  }

  OFERTA_PACK {
    bigserial id PK
    bigint oferta_id FK
    bigint pack_id FK
    numeric porc_descuento
  }

  OFERTA_TRATAMIENTO {
    bigserial id PK
    bigint oferta_id FK
    bigint tratamiento_id FK
    numeric porc_descuento
  }

  OFERTA_COMBO {
    bigserial id PK
    bigint oferta_id FK
    int min_packs
    numeric porc_descuento_adicional
  }

  OFERTA_COMBO_PACK {
    bigserial id PK
    bigint oferta_combo_id FK
    bigint pack_id FK
  }

  VENTA {
    bigserial id PK
    bigint ficha_id FK
    bigint evaluacion_id FK
    bigint tratamiento_id FK
    bigint pack_id FK
    int cantidad_sesiones
    numeric precio_lista
    numeric descuento_manual_pct
    numeric descuento_aplicado_total
    numeric total_pagado
    varchar estado
    text observaciones
    timestamptz fecha_creacion
    timestamptz fecha_actualizacion
  }

  VENTA_OFERTA {
    bigserial id PK
    bigint venta_id FK
    bigint oferta_id FK
    int secuencia
    numeric porc_descuento
    numeric monto_descuento
  }

  PAGO {
    bigserial id PK
    bigint venta_id FK
    numeric monto_total
    varchar estado
    text observaciones
    timestamptz fecha_creacion
  }

  PAGO_DETALLE {
    bigserial id PK
    bigint pago_id FK
    numeric monto
    varchar metodo_pago
    varchar referencia
    text observaciones
    timestamptz fecha_pago
  }

  SUCURSAL {
    bigserial id PK
    varchar nombre
    varchar direccion
    varchar telefono
    varchar email
    boolean activo
    timestamptz fecha_creacion
  }

  BOX {
    bigserial id PK
    bigint sucursal_id FK
    varchar nombre
    varchar descripcion
    boolean activo
    timestamptz fecha_creacion
  }

  PROFESIONAL {
    bigserial id PK
    varchar nombre
    varchar apellidos
    varchar rut
    varchar telefono
    varchar email
    varchar tipo_profesional
    text bio
    text foto_url
    boolean activo
    timestamptz fecha_creacion
  }

  SESION {
    bigserial id PK
    bigint venta_id FK
    int numero_sesion
    bigint sucursal_id FK
    bigint box_id FK
    bigint profesional_id FK
    varchar google_calendar_event_id
    timestamptz fecha_planificada
    timestamptz fecha_ejecucion
    varchar estado
    boolean paciente_confirmado
    timestamptz abierta_en
    timestamptz cerrada_en
    text observaciones
    jsonb intensidades_zonas
    jsonb datos_sesion
    timestamptz fecha_creacion
    timestamptz fecha_actualizacion
  }
